<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>Trip Logger | bemasher.net</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

<link href="https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Mono:wght@100..900&display=swap" rel="stylesheet">


    <link rel="stylesheet" href="/css/main.css">


      <script src="/js/main.js"></script>


</head>
<body>
  <header>
    <h1>bemasher.net</h1>

  <nav>
    
    
      <a href="/">Home</a>
    
    
  </nav>


  </header>
  <main>
    
  <h1>Trip Logger</h1>

  
  
  <time datetime="2024-03-07T18:08:15-07:00">March 7, 2024</time>

  <p>I like data, especially discovering interesting patterns in it. My car, a 2019 Honda Civic Hatchback produces an awful lot of it without even having to ask for it. This project is about collecting that data and having a look at it.</p>
<p>Vehicles manufactured after 1996 in the United States are required to implement OBD-II, an on-board diagnostics reporting capability.<sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup> Luckily the standard requires a specific connector, placement, pinout, and permits a set of signaling protocols.</p>
<p>My Civic implements a few of these protocols, but the one of interest is Controller Area Network (CAN). One way to interact with your vehicle is using an ELM327-based<sup id="fnref:2"><a href="#fn:2" class="footnote-ref" role="doc-noteref">2</a></sup> device. These affordable devices abstract away the complexity of OBD-II behind a device with an AT command set.<sup id="fnref:3"><a href="#fn:3" class="footnote-ref" role="doc-noteref">3</a></sup></p>
<p>Years ago I purchased an ELM327 knockoff, but I never got very far into the weeds with it because it required a Wi-Fi connection, and in my case an app on my iPhone, none of which were open-source, free, or well-made. The device was also always on (draining my vehicle&rsquo;s battery), and the Wi-Fi access point had a hard-coded SSID and PSK, so I only used it when I needed a known-working implementation of OBD-II.</p>
<p>What I really wanted was trip logs that began at engine start, and ended at engine shutoff. Bonus points if these logs can be sync&rsquo;d to my server when WiFi is in range.</p>
<p>The design requirements are as follows:</p>
<ul>
<li>Automatic boot at engine start.</li>
<li>Automatic logging at boot.</li>
<li>Log both CAN and GPS data.</li>
<li>Automatic (safe) shutdown.</li>
</ul>
<h1 id="power">Power</h1>
<p>For automatic boot and shutdown, the Pi will boot whenever power is present, and shutdown (unsafely) when power is absent.</p>
<p>To power the Pi, there are a few options:</p>
<ul>
<li>USB, there&rsquo;s a port in the center console that supplies enough current to run the Pi. This port is powered when the engine is running, or in accessory mode. This provides automatic boot at engine start, and automatic (unsafe) shutdown at engine stop.</li>
<li>12V accessory port, this port only provides power when the engine is running.</li>
<li>OBD-II provides a direct connection to the battery, so I&rsquo;ll need a way to handle boot and shutdown on the Pi.</li>
</ul>
<p>Powering the Pi directly from the battery through the OBD-II port makes the most sense. This requires a DC-DC converter to get 5V from the 12V-ish battery. I&rsquo;ve already got some cheap DC-DC buck converter modules<sup id="fnref:4"><a href="#fn:4" class="footnote-ref" role="doc-noteref">4</a></sup> rated for the necessary current.</p>
<p>A power button can be emulated using <code>dtoverlay=gpio-shutdown</code> which triggers when a specified GPIO pin is driven low. One of the two push-buttons on the PiCAN 2 can be used for this, and it allows triggering both boot and safe shutdown. I&rsquo;ll have to measure how much power the device and peripherals draw when everything is shutdown or asleep.</p>
<p>I&rsquo;ve not yet determined how I&rsquo;ll handle automatic boot, for now I think I&rsquo;ll manually start the Pi with the push button. Automatic shutdown is easy: everything on the CAN bus stops transmitting shortly after the engine stops, so use a timeout to trigger shutdown after the last message is received.</p>
<h1 id="can-interface">CAN Interface</h1>
<p>There are quite a few accessory boards for platforms like the Raspberry Pi that marry a CAN controller,<sup id="fnref:5"><a href="#fn:5" class="footnote-ref" role="doc-noteref">5</a></sup> and transceiver<sup id="fnref:6"><a href="#fn:6" class="footnote-ref" role="doc-noteref">6</a></sup> to the pi. For this project, the most suitable for development I found is the PiCAN 2.<sup id="fnref:7"><a href="#fn:7" class="footnote-ref" role="doc-noteref">7</a></sup> This board includes both screw terminals and a DB-9 connector for connecting to the bus.</p>
<p>There are also some unpopulated footprints on the board for a switch-mode power supply, and momentary push buttons, which I&rsquo;ll populate.</p>
<p>Be careful when setting up this board for first use, a triplet of solder jumpers need to be set for the specific cable you&rsquo;ll use. I purchased an OBD-II to DB-9 cable from Adafruit.<sup id="fnref:8"><a href="#fn:8" class="footnote-ref" role="doc-noteref">8</a></sup> It&rsquo;s pinout corresponds to the &ldquo;CAN Cable&rdquo; instead of the &ldquo;OBDII Cable&rdquo; described in the user guide.</p>
<h1 id="gps">GPS</h1>
<p>The vehicle doesn&rsquo;t know where it is in space and time, and GPS is a relatively easy way to get this data.</p>
<p>The Pi doesn&rsquo;t have a real-time clock, so when it first boots, it&rsquo;s not oriented to time. GPS is effectively a collection of very accurate clocks, so that problem is solved.</p>
<p>There are a few benefits to the device always having power: GPS time to first fix from cold boot is around 30 seconds, but if the GPS always has power and is instead put to sleep, TTFF is around 1 second, so the Pi has current time sooner.</p>
<p>For this application, I already have a u-blox MAX-M8Q module<sup id="fnref:9"><a href="#fn:9" class="footnote-ref" role="doc-noteref">9</a></sup> from Uputronics. I may replace this with the GPS/RTC hat<sup id="fnref:10"><a href="#fn:10" class="footnote-ref" role="doc-noteref">10</a></sup> from Uputronics to simplify the assembled package.</p>
<h1 id="thats-all-for-now">That&rsquo;s all for now.</h1>
<p>Tune in at some indeterminate future time for some software.</p>
<div class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1">
<p><a href="https://en.wikipedia.org/wiki/On-board_diagnostics">Wikipedia: On-board Diagnostics</a>&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:2">
<p><a href="https://en.wikipedia.org/wiki/ELM327">Wikipedia: ELM327</a>&#160;<a href="#fnref:2" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:3">
<p><a href="https://en.wikipedia.org/wiki/Hayes_AT_command_set">Wikipedia: Hayes AT command set</a>&#160;<a href="#fnref:3" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:4">
<p><a href="https://a.co/d/e0n8oBu">LM2596 DC-DC Buck Converter Module</a>&#160;<a href="#fnref:4" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:5">
<p><a href="https://ww1.microchip.com/downloads/en/DeviceDoc/MCP2515-Stand-Alone-CAN-Controller-with-SPI-20001801J.pdf">MCP2515 Stand-Alone CAN Controller with SPI Interface</a>&#160;<a href="#fnref:5" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:6">
<p><a href="https://ww1.microchip.com/downloads/aemDocuments/documents/APID/ProductDocuments/DataSheets/20001667G.pdf">MCP2551 High-speed CAN Transceiver</a>&#160;<a href="#fnref:6" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:7">
<p><a href="https://copperhilltech.com/pican-2-can-bus-interface-for-raspberry-pi/">PiCAN 2 CAN Bus Interface for Raspberry Pi</a>&#160;<a href="#fnref:7" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:8">
<p><a href="https://www.adafruit.com/product/4841">OBD Plug (16-pin) to DE-9 (DB-9) Socket Adapter Cable - 1 meter long</a>&#160;<a href="#fnref:8" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:9">
<p><a href="https://store.uputronics.com/index.php?route=product/product&amp;path=60_64&amp;product_id=84">uBLOX MAX-M8Q Breakout for Active Antennas 5V</a>&#160;<a href="#fnref:9" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
<li id="fn:10">
<p><a href="https://store.uputronics.com/index.php?route=product/product&amp;path=60_64&amp;product_id=81">Raspberry Pi GPS/RTC Expansion Board</a>&#160;<a href="#fnref:10" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</div>

  
  <div>
    <div>Tags:
      
      <a href="/tags/trip-logger/">Trip Logger</a></div>
  </div>


  </main>
  <footer>
    <p>Copyright 2024. All rights reserved.</p>

  </footer>
</body>
</html>
